openapi: 3.0.3
info:
  title: Dédalo API v1 (JSON endpoint)
  version: "1.0.0"
  description: |-
    Compact OpenAPI skeleton for the single JSON entrypoint used by Dédalo.
    The API receives a Request Query Object (RQO) describing `dd_api`, `action` and
    payload objects such as `source`, `sqo`, `options` and `data`.
servers:
  - url: /
paths:
  /core/api/v1/json/index.php:
    post:
      summary: Dédalo JSON API entrypoint
      description: |-
        Single POST endpoint accepting JSON RQO (Request Query Object).
        Dispatches to appropriate API class/method based on `dd_api` and `action` fields.
      operationId: jsonApiEntrypoint
      tags:
        - API
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RQO'
            examples:
              dd_core_api_read:
                summary: Read section records (from dd_core_api.md)
                value:
                  dd_api: dd_core_api
                  action: read
                  source:
                    section_tipo: rsc167
                    mode: edit
                  sqo:
                    limit: 10
                    offset: 0
              dd_core_api_save:
                summary: Save component data (from dd_core_api.md)
                value:
                  dd_api: dd_core_api
                  action: save
                  source:
                    type: component
                    model: component_input_text
                    tipo: oh16
                    section_tipo: oh1
                    section_id: 124
                    mode: edit
                  data:
                    changed_data:
                      - action: update
                        key: 0
                        value: title2
              dd_utils_api_login:
                summary: Authenticate user (from dd_utils_api.md)
                value:
                  dd_api: dd_utils_api
                  action: login
                  options:
                    username: admin
                    auth: secret
              dd_utils_api_get_system_info:
                summary: Get system diagnostics (from dd_utils_api.md)
                value:
                  dd_api: dd_utils_api
                  action: get_system_info
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/APIResponse'
                  - $ref: '#/components/schemas/APIResponseError'
              examples:
                dd_core_api_read_success:
                  summary: Read response example
                  value:
                    result:
                      context: []
                      data:
                        - id: 2
                          title: Example record
                    msg: OK
                    errors: []
                dd_utils_api_login_success:
                  summary: Login response example
                  value:
                    result: true
                    msg: Login successful
                    session:
                      user_id: 1
                      username: admin
                      token: REDACTED_TOKEN
                dd_utils_api_system_info:
                  summary: System info response example
                  value:
                    result: true
                    msg: OK
                    system:
                      max_size_bytes: 10485760
                      sys_get_temp_dir: /tmp
                      upload_tmp_dir: /var/www/uploads/tmp
                      pdf_ocr_engine: tesseract
        '400':
          description: Bad request (invalid RQO or missing required fields)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIResponseError'
        '401':
          description: Unauthorized (login required or invalid credentials)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIResponseError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIResponseError'
components:
  schemas:
    APIResponse:
      type: object
      description: Successful API response object (structure varies by API method).
      properties:
        result:
          oneOf:
            - type: object
              description: Complex response data (context, data, element details, etc.)
            - type: boolean
              description: Simple boolean result
            - type: string
              description: String result
        msg:
          type: string
          description: Human-readable message (e.g. "OK", "Saved", "Login successful")
        errors:
          type: array
          items:
            type: string
          description: Array of error/warning messages
        session:
          type: object
          description: Optional session info (e.g. user_id, token after login)
      required:
        - result
        - msg
    APIResponseError:
      type: object
      description: Error API response object.
      properties:
        result:
          type: boolean
          enum: [false]
          description: Always false on error
        msg:
          type: string
          description: Error message
        errors:
          type: array
          items:
            type: string
          description: Array of detailed error messages
      required:
        - result
        - msg
    RQO:
      type: object
      description: |-
        Request Query Object (RQO) accepted by the JSON endpoint.
        Minimal required fields are `dd_api` and `action`.
        Additional fields depend on the target API class and action.
      properties:
        dd_api:
          type: string
          description: |-
            API class name. Examples: `dd_core_api`, `dd_utils_api`, `dd_manager`,
            `dd_component_text_area_api`, `dd_tools_api`, etc.
          examples:
            - dd_core_api
            - dd_utils_api
        action:
          type: string
          description: |-
            Method/action name to invoke on the API class.
            Examples: `read`, `save`, `login`, `get_system_info`, etc.
          examples:
            - read
            - save
            - login
        source:
          type: object
          description: |-
            Locator or context object describing section/record information.
            May include: `section_tipo`, `section_id`, `tipo`, `model`, `mode`, etc.
          example:
            section_tipo: rsc167
            section_id: 123
            mode: edit
        sqo:
          $ref: '#/components/schemas/SQO'
        show:
          $ref: '#/components/schemas/SHOW'
        options:
          type: object
          description: |-
            Arbitrary options object used by many API calls.
            Structure varies by API/action. Examples: `username`, `auth` (for login),
            `key_dir`, `file_name` (for upload), etc.
        data:
          type: object
          description: |-
            Payload data for create/update/save operations.
            Typically contains `changed_data` array for component saves.
        prevent_lock:
          type: boolean
          description: When true, prevent locking behavior on save operations
          default: false
        pretty_print:
          type: boolean
          description: Request pretty-printed JSON response
          default: false
        api_engine:
          type: string
          description: |-
            Optional: specify a particular API engine or server role
            (e.g. `ontology_server`, `code_server`)
      required:
        - dd_api
        - action
      examples:
        - dd_api: dd_core_api
          action: read
          source:
            section_tipo: rsc167
            mode: edit
          sqo:
            limit: 10
        - dd_api: dd_utils_api
          action: login
          options:
            username: admin
            auth: password123
    SQO:
      type: object
      description: |-
        Search Query Object (SQO) used by list/count/search operations.
        Allows filtering, ordering, pagination of results.
      properties:
        section_tipo:
          anyOf:
            - type: string
              description: Single section tipo to search within
            - type: array
              items:
                type: string
              description: Multiple section tipos (OR logic)
        filter_by_list:
          type: array
          items:
            type: object
          description: Array of filter objects (varies by ontology)
        where:
          type: array
          items:
            type: object
          description: SQL-like WHERE conditions
          example:
            - field: title
              op: like
              value: "%example%"
        limit:
          type: integer
          description: Maximum number of results to return
          example: 10
        offset:
          type: integer
          description: Pagination offset (skip N results)
          example: 0
        order_by:
          type: string
          description: Field to order results by
    SHOW:
      type: object
      description: Display/visibility map controlling which columns/fields are shown.
      properties:
        columns:
          type: array
          items:
            type: string
          description: Array of column names to display
          example:
            - title
            - date_created
            - status

